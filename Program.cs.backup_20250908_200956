using OfficeOpenXml;

var builder = WebApplication.CreateBuilder(args);

// Configure EPPlus 8.1.0 license - safe approach
try
{
    if (ExcelPackage.LicenseContext != LicenseContext.NonCommercial)
    {
        ExcelPackage.LicenseContext = LicenseContext.NonCommercial;
    }
}
catch (Exception)
{
    // License will be set when needed
}

builder.Services.AddControllers();
builder.Services.AddEndpointsApiExplorer();
builder.Services.AddSwaggerGen();
builder.Services.AddCors(options =>
{
    options.AddDefaultPolicy(builder =>
    {
        builder.AllowAnyOrigin()
               .AllowAnyMethod()
               .AllowAnyHeader();
    });
});
var app = builder.Build();
app.UseCors();
// Middleware para corrigir headers
app.Use(async (context, next) =>
{
    var path = context.Request.Path.Value?.ToLower() ?? "";
    
    // Definir Content-Type correto com charset para recursos locais
    if (path.EndsWith(".html"))
    {
        context.Response.Headers["Content-Type"] = "text/html; charset=utf-8";
        context.Response.Headers["Cache-Control"] = "no-cache";
    }
    else if (path.EndsWith(".css"))
    {
        context.Response.Headers["Content-Type"] = "text/css; charset=utf-8";
        context.Response.Headers["Cache-Control"] = "public, max-age=31536000, immutable";
    }
    else if (path.EndsWith(".js"))
    {
        context.Response.Headers["Content-Type"] = "application/javascript; charset=utf-8";
        context.Response.Headers["Cache-Control"] = "public, max-age=31536000, immutable";
    }
    
    // Remover header Expires para todos os recursos
    context.Response.Headers.Remove("Expires");
    
    await next();
});
app.UseDefaultFiles();
app.UseStaticFiles();
app.UseSwagger();
app.UseSwaggerUI();
app.MapControllers();
app.MapGet("/", () => Results.Redirect("/index.html"));
Console.WriteLine("? EmpresaX POS API iniciada!");
Console.WriteLine("??? Interface: http://localhost:5245");
Console.WriteLine("?? Swagger: http://localhost:5245/swagger");
app.Run();
